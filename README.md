# nrsc5_resample_tool

This tool is designed to process I/Q recordings from Software Defined Radios (SDRs), preparing them for use with the [nrsc5](https://github.com/theori-io/nrsc5) HD Radio decoder. As a flexible pre-processor, it handles 8-bit or 16-bit I/Q WAV files and performs the necessary resampling and frequency shifting to align the signal for successful decoding.

---

### ⚠️ Important Note: Heavy AI-Assisted Development

**The development of this project was largely assisted by a large language model (AI).** The initial code structure, core logic, and build systems were generated by AI and have since been guided, reviewed, and tested by a human developer.

While the tool is functional and has been refined, its unique development process means it has not undergone the same long-term, iterative evolution as a traditional open-source project. It should still be considered experimental.

**Please be aware of the following:**
*   **Potential for Bugs:** Issues are still likely present. Subtle bugs, logical errors, or memory management issues may exist.
*   **Edge Cases:** The tool may not gracefully handle all possible inputs, file formats, or command-line argument combinations.
*   **Security:** No formal security audit has been performed. Use caution with untrusted input files.

While the tool is fully functional, it should be treated as experimental software due to its origins. Please use it with this context in mind and review the code if you intend to use it for any critical purpose.

---

### Key Features

*   **Resampling for nrsc5:** Converts common SDR sample rates to the specific rates required by `nrsc5`.
*   **Multiple Output Modes:**
    *   `cu8`: Universal 8-bit complex for AM/FM HD Radio (1,488,375 Hz).
    *   `cs16_fm`: 16-bit complex for FM HD Radio (744,187.5 Hz).
    *   `cs16_am`: 16-bit complex for AM HD Radio (46,511.71875 Hz).
*   **Frequency Shifting:**
    *   Automatically calculates the required shift if the input file contains center frequency metadata and a `--target-freq` is provided.
    *   Allows for manual frequency shifting with `--shift-freq`.
*   **Metadata Parsing:**
    *   Reads `auxi` chunks from WAV files created by software like SDR Console, SDRconnect, and SDRuno.
    *   Parses frequency and timestamp information from SDR# style filenames (e.g., `..._20240520_181030Z_97300000Hz_...`).
*   **Cross-Platform:** Uses CMake for building on Linux, Windows, and other POSIX systems.
*   **Efficient Processing:** Employs a multi-threaded producer-consumer pipeline (read -> process -> write) to maximize throughput on multi-core systems.

### Dependencies

To build this project, you will need:
*   A C99 compliant C compiler (GCC, Clang, or MSVC).
*   **CMake** (version 3.10 or higher).
*   **libsndfile** (development libraries).
*   **liquid-dsp** (development libraries).
*   **libexpat** (development libraries).
*   **pthreads** (On Linux/macOS this is standard; on Windows, MinGW provides a version).

### Building the Project

#### On Linux (Recommended)

1.  **Install Dependencies:**
    ```bash
    # On Debian/Ubuntu
    sudo apt-get update
    sudo apt-get install build-essential cmake libsndfile1-dev libliquid-dev libexpat1-dev

    # On Fedora/CentOS
    sudo dnf install cmake gcc-c++ libsndfile-devel liquid-dsp-devel expat-devel
    ```

2.  **Configure and Build:**
    ```bash
    git clone <repository-url>
    cd nrsc5_resample_tool

    mkdir build && cd build
    cmake ..
    make -j$(nproc)
    ```
    The executable `nrsc5_resample_tool` will be in the `build` directory.

#### On Windows (Cross-Compiling with MinGW)

The repository includes a helper script `build-win.sh` for cross-compiling from a Linux host.

**Note:** This script is brittle and contains **hardcoded paths**. You must edit the script to point to the locations of your MinGW toolchain and pre-built Windows dependencies. The `avx` and `avx2` options correspond to different builds of the `liquid-dsp` library. Linking against a version compiled with instruction sets supported by your target CPU (like AVX2) may offer a slight performance increase.

```bash
# Edit build-win.sh to match your environment first!
./build-win.sh 64 avx2

### Usage

#### Command-Line Options

```text
Usage: nrsc5_resample_tool --input <file> {--file <path> | --stdout} [options]

Description:
  Resamples an I/Q WAV file to a format compatible with the nrsc5 HD Radio decoder.

Required Arguments:
  -i, --input <file>          I/Q input file (8-bit or 16-bit WAV).

Output Destination (Required, choose one):
  -f, --file <file>           Output to a file.
  -o, --stdout                Output binary data to stdout for piping to another program (e.g., nrsc5).

Options:
  -m, --mode <name>           Output mode. (Optional, Default: cu8).
                              cu8:      Universal 8-bit for AM/FM HD Radio decoding (1488375 Hz).
                              cs16_fm:  16-bit complex for FM HD Radio decoding (744187.5 Hz).
                              cs16_am:  16-bit complex for AM HD Radio decoding (46511.71875 Hz).

  -c, --target-freq <hz>      Shift signal to a new target center frequency (e.g., 97.3e6).
                              (Recommended for SDR captures with frequency metadata).

  -F, --shift-freq <hz>       Apply a direct frequency shift in Hz.
                              (Use if input lacks metadata or for manual correction).

  -x, --shift-after           Apply frequency shift AFTER resampling (default is before).
                              (A workaround for narrow I/Q recordings where only a single
                               HD sideband is present).

  -s, --scale <value>         Scaling factor for input samples (Default: 0.02 for cu8, 0.5 for cs16).
```

#### Examples
**Example 1: Basic resampling to a file**
Resample a 16-bit WAV file to the default cu8 format.
```bash
nrsc5_resample_tool -i my_capture.wav -f my_capture.cu8
```
**Example 2: Piping directly to nrsc5**
Resample and shift a signal to the target station, then pipe it to nrsc5 to decode the first program (0). (Assumes the WAV has metadata).
```bash
nrsc5_resample_tool -i sdrsharp_capture.wav -c 97.3e6 -o | nrsc5 -r - 0
```

**Example 3: Manual frequency shift**
Apply a direct -400 kHz shift to the signal and pipe to nrsc5 to decode the first program.
```bash
nrsc5_resample_tool -i my_capture.wav -F -400e3 -o | nrsc5 -r - 0
```
**Example 4: Shifting frequency after resampling**
Use the -x flag as a workaround for narrow recordings where the HD sideband is near the edge of the passband.
```bash
nrsc5_resample_tool -i narrow_capture.wav -F 192e3 -x -o | nrsc5 -r - 0
```
### Known Issues and Limitations

*   **Experimental:** As stated above, the code is not as extensively tested as a mature project and may contain bugs.
*   **32-Bit Builds:** The build scripts are currently configured for 64-bit systems only.
*   **Cross-Compile Script:** The `build-win.sh` script is not a general-purpose solution and requires manual editing.

### Contributing

Contributions are highly welcome! If you find a bug, a logical error, or an area for improvement, please feel free to:
1.  Open an issue to describe the problem.
2.  Submit a pull request with a fix.
