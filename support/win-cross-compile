#!/usr/bin/env bash

set -e

root=$(cd "$(dirname "$0")/.." && pwd)

if [ "$1" != 64 ]; then
    echo "Usage: $0 64 [avx|avx2] [make flags]"
    echo "32-bit build not yet supported"
    exit 1
fi

build_type=$2
if [ "$build_type" != "avx" ] && [ "$build_type" != "avx2" ]; then
    echo "Usage: $0 64 [avx|avx2] [make flags]"
    echo "Invalid build type specified."
    exit 1
fi

shift 2
make_args="$*"

prefix=${root}/build-win64-${build_type}
host=x86_64-w64-mingw32
liquid_library_path="/usr/local/src/windows_deps_files/src/liquid-dsp/build-win64-${build_type}/libliquid.dll.a"

mkdir -p ${prefix}
cd ${prefix}

cmake \
    -D CMAKE_SYSTEM_NAME=Windows \
    -D CMAKE_C_COMPILER=${host}-gcc \
    -D SNDFILE_INCLUDE_DIR=/usr/local/src/windows_deps_files/src/libsndfile/include \
    -D SNDFILE_LIBRARY=/usr/local/src/windows_deps_files/src/libsndfile/build-win64/libsndfile.dll.a \
    -D LIQUID_INCLUDE_DIR=/usr/local/src/windows_deps_files/src/liquid-dsp/include \
    -D LIQUID_LIBRARY=${liquid_library_path} \
    -D EXPAT_INCLUDE_DIR=/usr/local/src/windows_deps_files/src/libexpat/expat/lib \
    -D EXPAT_LIBRARY=/usr/local/src/windows_deps_files/src/libexpat/expat/build-win64/libexpat.dll.a \
    ..

make ${make_args}
